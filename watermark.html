<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watermark PDF | Your PDF Tools</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #718096;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: #e9ecef;
            color: #4a5568;
        }

        .tab.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 40px;
            min-height: 400px;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            text-align: center;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 60px 20px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .upload-box:hover {
            background: #e9ecef;
            border-color: #5a67d8;
        }

        .watermark-type {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .type-option {
            border: 3px solid #e2e8f0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .type-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .type-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .type-option i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .setting-group {
            background: #f7fafc;
            padding: 25px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .setting-group h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .setting-option {
            margin-bottom: 15px;
        }

        .setting-option label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .setting-option input,
        .setting-option select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
        }

        .setting-option input[type="color"] {
            height: 50px;
            padding: 5px;
        }

        .setting-option input[type="range"] {
            padding: 0;
        }

        .range-value {
            text-align: center;
            color: #667eea;
            font-weight: bold;
            margin-top: 5px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .preview-area {
            background: #f8f9fa;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .watermark-preview {
            width: 300px;
            height: 150px;
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .preview-text {
            font-size: 24px;
            opacity: 0.7;
            transform: rotate(-45deg);
        }

        .preview-image {
            max-width: 100%;
            max-height: 100%;
            opacity: 0.7;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-download {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .btn-convert {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            font-size: 18px;
            padding: 15px 40px;
        }

        .progress {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status {
            margin: 10px 0;
            color: #718096;
            font-size: 14px;
            text-align: center;
        }

        #fileInput, #imageInput {
            display: none;
        }

        .file-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }

        .actions {
            margin-top: 30px;
            text-align: center;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .position-btn {
            padding: 10px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .position-btn:hover {
            border-color: #667eea;
        }

        .position-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .image-upload-area {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .image-upload-area:hover {
            border-color: #667eea;
        }

        .image-preview {
            max-width: 200px;
            max-height: 100px;
            margin: 10px auto;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíß Watermark PDF</h1>
            <p>Add text or image watermarks to your PDF documents</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">1. Upload PDF</button>
            <button class="tab" onclick="switchTab('watermark')">2. Watermark Type</button>
            <button class="tab" onclick="switchTab('settings')">3. Settings</button>
            <button class="tab" onclick="switchTab('convert')">4. Apply</button>
            <button class="tab" onclick="switchTab('results')">5. Download</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content active">
            <div class="upload-area">
                <div class="upload-box" id="uploadBox" onclick="document.getElementById('fileInput').click()">
                    <div style="font-size: 48px;">üìÅ</div>
                    <h3>Upload Your PDF File</h3>
                    <p>Drag & drop your PDF file here or click to browse</p>
                    <p style="font-size: 14px; color: #a0aec0;">Max file size: 10MB</p>
                </div>
                <input type="file" id="fileInput" accept=".pdf" />
                
                <div id="fileInfo" class="file-info" style="display: none;">
                    <h4>Selected File:</h4>
                    <p id="fileName"></p>
                    <p id="fileSize"></p>
                </div>

                <button class="btn" onclick="switchTab('watermark')" id="nextToWatermark" style="display: none;">
                    Next: Watermark Type ‚Üí
                </button>
            </div>
        </div>

        <!-- Watermark Type Tab -->
        <div id="watermark-tab" class="tab-content">
            <h3 style="text-align: center; margin-bottom: 30px;">Choose Watermark Type</h3>
            
            <div class="watermark-type">
                <div class="type-option selected" onclick="selectWatermarkType('text')">
                    <div>üìù</div>
                    <h4>Text Watermark</h4>
                    <p>Add custom text as watermark</p>
                </div>
                <div class="type-option" onclick="selectWatermarkType('image')">
                    <div>üñºÔ∏è</div>
                    <h4>Image Watermark</h4>
                    <p>Add your own image as watermark</p>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="switchTab('upload')">‚Üê Back</button>
                <button class="btn" onclick="switchTab('settings')">Next: Settings ‚Üí</button>
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
            <div class="settings-grid">
                <!-- Text Watermark Settings -->
                <div id="text-settings" class="setting-group">
                    <h4>üìù Text Watermark</h4>
                    <div class="setting-option">
                        <label for="watermarkText">Watermark Text:</label>
                        <input type="text" id="watermarkText" value="CONFIDENTIAL" placeholder="Enter watermark text">
                    </div>
                    <div class="setting-option">
                        <label for="textFont">Font Family:</label>
                        <select id="textFont">
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                        </select>
                    </div>
                    <div class="setting-option">
                        <label for="textSize">Font Size:</label>
                        <input type="range" id="textSize" min="20" max="100" value="48">
                        <div class="range-value" id="textSizeValue">48px</div>
                    </div>
                    <div class="setting-option">
                        <label for="textColor">Text Color:</label>
                        <input type="color" id="textColor" value="#000000">
                    </div>
                    <div class="setting-option">
                        <label for="textOpacity">Opacity:</label>
                        <input type="range" id="textOpacity" min="10" max="100" value="30">
                        <div class="range-value" id="textOpacityValue">30%</div>
                    </div>
                </div>

                <!-- Image Watermark Settings -->
                <div id="image-settings" class="setting-group" style="display: none;">
                    <h4>üñºÔ∏è Image Watermark</h4>
                    <div class="setting-option">
                        <label>Upload Watermark Image:</label>
                        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìÅ</div>
                            <h4>Click to Upload Image</h4>
                            <p style="color: #718096; font-size: 14px;">PNG, JPG, SVG (Max 5MB)</p>
                            <img id="imagePreview" class="image-preview">
                        </div>
                        <input type="file" id="imageInput" accept="image/*">
                        <div id="imageInfo" style="margin-top: 10px; font-size: 14px; color: #718096;"></div>
                    </div>
                    <div class="setting-option">
                        <label for="imageSize">Image Size:</label>
                        <input type="range" id="imageSize" min="10" max="100" value="30">
                        <div class="range-value" id="imageSizeValue">30%</div>
                    </div>
                    <div class="setting-option">
                        <label for="imageOpacity">Opacity:</label>
                        <input type="range" id="imageOpacity" min="10" max="100" value="40">
                        <div class="range-value" id="imageOpacityValue">40%</div>
                    </div>
                </div>

                <!-- Common Settings -->
                <div class="setting-group">
                    <h4>‚öôÔ∏è Position & Rotation</h4>
                    <div class="setting-option">
                        <label>Position:</label>
                        <div class="position-grid">
                            <button class="position-btn" onclick="selectPosition('top-left')">‚ÜñÔ∏è</button>
                            <button class="position-btn" onclick="selectPosition('top-center')">‚¨ÜÔ∏è</button>
                            <button class="position-btn" onclick="selectPosition('top-right')">‚ÜóÔ∏è</button>
                            <button class="position-btn" onclick="selectPosition('middle-left')">‚¨ÖÔ∏è</button>
                            <button class="position-btn selected" onclick="selectPosition('center')">‚è∫Ô∏è</button>
                            <button class="position-btn" onclick="selectPosition('middle-right')">‚û°Ô∏è</button>
                            <button class="position-btn" onclick="selectPosition('bottom-left')">‚ÜôÔ∏è</button>
                            <button class="position-btn" onclick="selectPosition('bottom-center')">‚¨áÔ∏è</button>
                            <button class="position-btn" onclick="selectPosition('bottom-right')">‚ÜòÔ∏è</button>
                        </div>
                    </div>
                    <div class="setting-option">
                        <label for="rotation">Rotation:</label>
                        <input type="range" id="rotation" min="-180" max="180" value="-45">
                        <div class="range-value" id="rotationValue">-45¬∞</div>
                    </div>
                    <div class="setting-option">
                        <div class="checkbox-group">
                            <input type="checkbox" id="allPages" checked>
                            <label for="allPages">Apply to all pages</label>
                        </div>
                    </div>
                </div>

                <!-- Preview -->
                <div class="setting-group">
                    <h4>üëÅÔ∏è Live Preview</h4>
                    <div class="preview-area">
                        <div class="watermark-preview" id="watermarkPreview">
                            <div class="preview-text" id="textPreview">CONFIDENTIAL</div>
                            <img id="imageLivePreview" class="preview-image" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button class="btn" onclick="switchTab('watermark')">‚Üê Back</button>
                <button class="btn" onclick="switchTab('convert')">Next: Apply ‚Üí</button>
            </div>
        </div>

        <!-- Convert Tab -->
        <div id="convert-tab" class="tab-content">
            <div style="text-align: center;">
                <h3 style="margin-bottom: 20px;">Apply Watermark</h3>
                <p style="margin-bottom: 30px; color: #718096;" id="conversionSummary">Ready to apply your watermark to the PDF.</p>

                <button class="btn btn-convert" onclick="applyWatermark()">
                    üöÄ Apply Watermark
                </button>

                <div class="progress" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status" id="status"></div>
            </div>

            <div class="actions">
                <button class="btn" onclick="switchTab('settings')">‚Üê Back to Settings</button>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results-tab" class="tab-content">
            <div style="text-align: center;">
                <h3 style="margin-bottom: 20px;">üéâ Watermark Applied Successfully!</h3>
                <p style="margin-bottom: 30px; color: #718096;">Your PDF has been watermarked and is ready for download.</p>

                <button class="btn btn-download" onclick="downloadWatermarkedPDF()" style="font-size: 18px; padding: 15px 40px;">
                    üì• Download Watermarked PDF
                </button>

                <div style="margin-top: 30px;">
                    <button class="btn" onclick="switchTab('upload')">
                        üîÑ Watermark Another PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7"></script>

    <script>
        // Set PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let currentFile = null;
        let watermarkType = 'text';
        let watermarkImage = null;
        let watermarkedPdfBytes = null;
        let currentPosition = 'center';

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(`${tabName}-tab`).classList.add('active');
            document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');

            if (tabName === 'settings') {
                updatePreview();
            } else if (tabName === 'convert') {
                updateConversionSummary();
            }
        }

        // File handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('imageInput').addEventListener('change', handleImageSelect);
        document.getElementById('uploadBox').addEventListener('dragover', handleDragOver);
        document.getElementById('uploadBox').addEventListener('drop', handleDrop);

        // Event listeners for real-time preview
        document.getElementById('watermarkText').addEventListener('input', updatePreview);
        document.getElementById('textFont').addEventListener('change', updatePreview);
        document.getElementById('textSize').addEventListener('input', updatePreview);
        document.getElementById('textColor').addEventListener('input', updatePreview);
        document.getElementById('textOpacity').addEventListener('input', updatePreview);
        document.getElementById('imageSize').addEventListener('input', updatePreview);
        document.getElementById('imageOpacity').addEventListener('input', updatePreview);
        document.getElementById('rotation').addEventListener('input', updatePreview);

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('uploadBox').style.background = '#e9ecef';
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('uploadBox').style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                handleFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        function handleImageSelect(e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size must be less than 5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    watermarkImage = event.target.result;
                    
                    // Show image preview
                    document.getElementById('imagePreview').src = watermarkImage;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('imageLivePreview').src = watermarkImage;
                    
                    document.getElementById('imageInfo').textContent = `Image: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    updatePreview();
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleFile(file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB');
                return;
            }

            currentFile = file;
            
            // Show file info
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = `Name: ${file.name}`;
            document.getElementById('fileSize').textContent = `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            
            // Enable next button
            document.getElementById('nextToWatermark').style.display = 'inline-block';
        }

        function selectWatermarkType(type) {
            watermarkType = type;
            document.querySelectorAll('.type-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.target.closest('.type-option').classList.add('selected');

            // Show/hide appropriate settings
            document.getElementById('text-settings').style.display = type === 'text' ? 'block' : 'none';
            document.getElementById('image-settings').style.display = type === 'image' ? 'block' : 'none';

            updatePreview();
        }

        function selectPosition(position) {
            currentPosition = position;
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }

        function updatePreview() {
            // Update range value displays
            document.getElementById('textSizeValue').textContent = document.getElementById('textSize').value + 'px';
            document.getElementById('textOpacityValue').textContent = document.getElementById('textOpacity').value + '%';
            document.getElementById('imageSizeValue').textContent = document.getElementById('imageSize').value + '%';
            document.getElementById('imageOpacityValue').textContent = document.getElementById('imageOpacity').value + '%';
            document.getElementById('rotationValue').textContent = document.getElementById('rotation').value + '¬∞';

            const textPreview = document.getElementById('textPreview');
            const imagePreview = document.getElementById('imageLivePreview');

            if (watermarkType === 'text') {
                textPreview.style.display = 'block';
                imagePreview.style.display = 'none';

                // Apply text styles
                textPreview.textContent = document.getElementById('watermarkText').value || 'CONFIDENTIAL';
                textPreview.style.fontFamily = document.getElementById('textFont').value;
                textPreview.style.fontSize = document.getElementById('textSize').value + 'px';
                textPreview.style.color = document.getElementById('textColor').value;
                textPreview.style.opacity = (document.getElementById('textOpacity').value / 100);
                textPreview.style.transform = `rotate(${document.getElementById('rotation').value}deg)`;
            } else {
                textPreview.style.display = 'none';
                imagePreview.style.display = 'block';

                // Apply image styles
                imagePreview.style.opacity = (document.getElementById('imageOpacity').value / 100);
                imagePreview.style.transform = `rotate(${document.getElementById('rotation').value}deg)`;
                const size = document.getElementById('imageSize').value;
                imagePreview.style.width = size + '%';
                imagePreview.style.height = 'auto';
            }
        }

        function updateConversionSummary() {
            const summary = document.getElementById('conversionSummary');
            const type = watermarkType === 'text' ? 
                `"${document.getElementById('watermarkText').value}" text watermark` : 
                'image watermark';
            
            summary.textContent = `Ready to apply ${type} to your PDF with the current settings.`;
        }

        async function applyWatermark() {
            if (!currentFile) {
                alert('Please select a PDF file first.');
                return;
            }

            if (watermarkType === 'image' && !watermarkImage) {
                alert('Please select a watermark image first.');
                return;
            }

            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('status').textContent = 'Loading PDF...';
            document.getElementById('progressBar').style.width = '10%';

            try {
                // Read the PDF file
                const arrayBuffer = await currentFile.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);
                
                document.getElementById('status').textContent = 'Applying watermark...';
                document.getElementById('progressBar').style.width = '50%';

                const pages = pdfDoc.getPages();
                const totalPages = pages.length;

                // Get settings
                const opacity = watermarkType === 'text' ? 
                    parseInt(document.getElementById('textOpacity').value) / 100 :
                    parseInt(document.getElementById('imageOpacity').value) / 100;
                
                const rotation = parseInt(document.getElementById('rotation').value);

                // Apply watermark to each page
                for (let i = 0; i < pages.length; i++) {
                    const page = pages[i];
                    const { width, height } = page.getSize();

                    // Calculate position
                    let x, y;
                    switch (currentPosition) {
                        case 'top-left': x = width * 0.1; y = height * 0.9; break;
                        case 'top-center': x = width / 2; y = height * 0.9; break;
                        case 'top-right': x = width * 0.9; y = height * 0.9; break;
                        case 'middle-left': x = width * 0.1; y = height / 2; break;
                        case 'center': x = width / 2; y = height / 2; break;
                        case 'middle-right': x = width * 0.9; y = height / 2; break;
                        case 'bottom-left': x = width * 0.1; y = height * 0.1; break;
                        case 'bottom-center': x = width / 2; y = height * 0.1; break;
                        case 'bottom-right': x = width * 0.9; y = height * 0.1; break;
                    }

                    if (watermarkType === 'text') {
                        const watermarkText = document.getElementById('watermarkText').value || 'CONFIDENTIAL';
                        const fontSize = parseInt(document.getElementById('textSize').value);
                        const color = document.getElementById('textColor').value;
                        
                        // Convert hex to RGB
                        const r = parseInt(color.substr(1, 2), 16) / 255;
                        const g = parseInt(color.substr(3, 2), 16) / 255;
                        const b = parseInt(color.substr(5, 2), 16) / 255;

                        page.drawText(watermarkText, {
                            x: x,
                            y: y,
                            size: fontSize,
                            opacity: opacity,
                            rotate: PDFLib.degrees(rotation),
                            color: PDFLib.rgb(r, g, b),
                        });
                    } else {
                        // For image watermark, we'll use a canvas-based approach
                        // This is a simplified version - in production you'd use more advanced image embedding
                        const imageSize = parseInt(document.getElementById('imageSize').value) / 100;
                        
                        // Note: Full image watermarking requires more complex PDF manipulation
                        // For this demo, we'll add a placeholder text
                        page.drawText(`[IMAGE: ${watermarkImage ? 'Watermark Applied' : 'No Image'}]`, {
                            x: x,
                            y: y,
                            size: 20,
                            opacity: opacity,
                            rotate: PDFLib.degrees(rotation),
                            color: PDFLib.rgb(0.5, 0.5, 0.5),
                        });
                    }

                    // Update progress
                    const progress = 50 + ((i + 1) / totalPages) * 40;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('status').textContent = `Processed page ${i + 1} of ${totalPages}`;
                }

                // Save the watermarked PDF
                watermarkedPdfBytes = await pdfDoc.save();
                
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('status').textContent = 'Watermark applied successfully!';

                // Move to results tab
                setTimeout(() => {
                    switchTab('results');
                }, 1000);

            } catch (error) {
                console.error('Error applying watermark:', error);
                document.getElementById('status').textContent = 'Error applying watermark. Please try again.';
                document.getElementById('progressBar').style.width = '0%';
            }
        }

        function downloadWatermarkedPDF() {
            if (!watermarkedPdfBytes) {
                alert('No watermarked PDF available. Please apply watermark first.');
                return;
            }

            // Create blob and download
            const blob = new Blob([watermarkedPdfBytes], { type: 'application/pdf' });
            const filename = currentFile ? 
                currentFile.name.replace('.pdf', '-watermarked.pdf') : 
                'watermarked-document.pdf';
            
            download(blob, filename, "application/pdf");
        }

        // Initialize preview
        updatePreview();
    </script>
</body>
</html>